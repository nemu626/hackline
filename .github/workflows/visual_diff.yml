name: Visual Diff

on:
  pull_request:

jobs:
  build_and_diff:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install --upgrade pip && pip install fonttools pillow

      - name: Build font (base)
        run: ./build.sh

      - name: Generate before image
        run: python3 visual_test.py

      - name: Upload before image
        id: upload_before
        uses: devicons/public-upload-to-imgur@v2.2.2
        with:
          path: build/test_image.png
          client_id: ${{ secrets.IMGUR_CLIENT_ID }}

      - name: Checkout head branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Build font (head)
        run: ./build.sh

      - name: Generate after image
        run: python3 visual_test.py

      - name: Upload after image
        id: upload_after
        uses: devicons/public-upload-to-imgur@v2.2.2
        with:
          path: build/test_image.png
          client_id: ${{ secrets.IMGUR_CLIENT_ID }}

      - name: Post visual diff comment
        uses: mshick/add-pr-comment@v2
        with:
          message-id: visual-diff
          message: |
            ### Visual Diff

            **Before** (base branch)
            ${{ fromJson(steps.upload_before.outputs.markdown_urls)[0] }}

            **After** (head branch)
            ${{ fromJson(steps.upload_after.outputs.markdown_urls)[0] }}
