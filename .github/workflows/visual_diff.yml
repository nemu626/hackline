name: Visual Diff

on:
  pull_request:

jobs:
  build_and_diff:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.base_ref }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install --upgrade pip && pip install fonttools pillow

      - name: Build font (base)
        run: ./build.sh

      - name: Generate before image
        run: python3 visual_test.py

      - name: Move before image
        run: mv build/test_image.png /tmp/before.png

      - name: Checkout head branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: Build font (head)
        run: ./build.sh

      - name: Generate after image
        run: python3 visual_test.py

      - name: Move after image
        run: mv build/test_image.png /tmp/after.png

      - name: Post visual diff comment
        uses: unsplash/comment-on-pr@v1
        with:
          msg: |
            ### Visual Diff

            **Before** (base branch)
            ![Before](/tmp/before.png)

            **After** (head branch)
            ![After](/tmp/after.png)
          check_for_duplicate_msg: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
