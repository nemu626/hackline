name: Visual Diff

on:
  pull_request:

jobs:
  build_and_diff:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Checkout head branch
        uses: actions/checkout@v4
        with:
          path: head

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: base

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install --upgrade pip && pip install fonttools pillow

      - name: Build font (base)
        run: ./build.sh --nerd
        working-directory: base

      - name: Generate before images
        run: |
          python3 head/visual_test.py --font-path base/build/HackLine-Regular.ttf --output-path /tmp/01_before_std.png
          python3 head/visual_test.py --font-path base/build/HackLineNF-Regular.ttf --output-path /tmp/03_before_nf.png

      - name: Build font (head)
        run: ./build.sh --nerd
        working-directory: head

      - name: Generate after images
        run: |
          python3 head/visual_test.py --font-path head/build/HackLine-Regular.ttf --output-path /tmp/02_after_std.png
          python3 head/visual_test.py --font-path head/build/HackLineJKNF-Regular.ttf --output-path /tmp/04_after_jknf.png

      - name: Upload images to R2
        id: upload
        run: |
          pip install awscli
          R2_BUCKET_NAME="${{ secrets.S3_BUCKET_NAME }}"
          R2_PUBLIC_URL="${{ secrets.R2_PUBLIC_URL }}"

          declare -A files
          files=(
            ["/tmp/01_before_std.png"]="before_std"
            ["/tmp/02_after_std.png"]="after_std"
            ["/tmp/03_before_nf.png"]="before_nf"
            ["/tmp/04_after_jknf.png"]="after_jknf"
          )

          for file_path in "${!files[@]}"; do
            if [ -f "$file_path" ]; then
              base_name="${files[$file_path]}"
              filename="${base_name}_${{ github.run_id }}_${{ github.run_attempt }}.png"
              aws s3 cp "$file_path" "s3://${R2_BUCKET_NAME}/${filename}" --endpoint-url "${{ secrets.R2_ENDPOINT }}" --acl public-read
              url_var_name="${base_name}_url"
              echo "${url_var_name}=${R2_PUBLIC_URL}/${filename}" >> $GITHUB_OUTPUT
            fi
          done
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESSKEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_SCCESS_KEY }}

      - name: Post visual diff comment
        uses: mshick/add-pr-comment@v2
        with:
          message-id: visual-diff
          message: |
            ### Visual Diff

            #### Standard Font Comparison (HackLine)
            | Before (base) | After (head) |
            |---|---|
            | ![Before](${{ steps.upload.outputs.before_std_url }}) | ![After](${{ steps.upload.outputs.after_std_url }}) |

            #### Nerd Font Comparison (HackLineNF vs HackLineJKNF)
            | Before (base) | After (head) |
            |---|---|
            | ![Nerd Font Before](${{ steps.upload.outputs.before_nf_url }}) | ![Nerd Font After](${{ steps.upload.outputs.after_jknf_url }}) |
