name: Visual Diff

on:
  pull_request:

jobs:
  build_and_diff:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Checkout head branch
        uses: actions/checkout@v4
        with:
          path: head

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: base

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install --upgrade pip && pip install fonttools pillow

      - name: Build font (base)
        run: ./build.sh
        working-directory: base

      - name: Generate before image (HackLine)
        run: python3 head/visual_test.py --font-path base/build/HackLine-Regular.ttf --output-path /tmp/01_before_hackline.png

      - name: Build font (head)
        run: ./build.sh --nerd
        working-directory: head

      - name: Generate after image (HackLine)
        run: python3 head/visual_test.py --font-path head/build/HackLine-Regular.ttf --output-path /tmp/02_after_hackline.png

      - name: Generate after image (HackLineJK)
        run: python3 head/visual_test.py --font-path head/build/HackLineJK-Regular.ttf --output-path /tmp/03_after_hackline_jk.png

      - name: Generate after image (HackLineNF)
        run: python3 head/visual_test.py --font-path head/build/HackLineNF-Regular.ttf --output-path /tmp/04_after_hackline_nf.png

      - name: Generate after image (HackLineJKNF)
        run: python3 head/visual_test.py --font-path head/build/HackLineJKNF-Regular.ttf --output-path /tmp/05_after_hackline_jknf.png

      - name: Upload images to R2
        id: upload
        run: |
          pip install awscli
          R2_BUCKET_NAME="${{ secrets.S3_BUCKET_NAME }}"
          R2_PUBLIC_URL="${{ secrets.R2_PUBLIC_URL }}"

          declare -A files
          files=(
            ["/tmp/01_before_hackline.png"]="01_before_hackline"
            ["/tmp/02_after_hackline.png"]="02_after_hackline"
            ["/tmp/03_after_hackline_jk.png"]="03_after_hackline_jk"
            ["/tmp/04_after_hackline_nf.png"]="04_after_hackline_nf"
            ["/tmp/05_after_hackline_jknf.png"]="05_after_hackline_jknf"
          )

          for file_path in "${!files[@]}"; do
            if [ -f "$file_path" ]; then
              base_name="${files[$file_path]}"
              filename="${base_name}_${{ github.run_id }}_${{ github.run_attempt }}.png"
              aws s3 cp "$file_path" "s3://${R2_BUCKET_NAME}/${filename}" --endpoint-url "${{ secrets.R2_ENDPOINT }}" --acl public-read
              url_var_name="${base_name}_url"
              echo "${url_var_name}=${R2_PUBLIC_URL}/${filename}" >> $GITHUB_OUTPUT
            fi
          done
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESSKEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_SCCESS_KEY }}

      - name: Post visual diff comment
        uses: mshick/add-pr-comment@v2
        with:
          message-id: visual-diff
          message: |
            ### Visual Diff

            #### Standard Fonts
            | Before (HackLine) | After (HackLineJK) |
            |---|---|
            | ![Before](${{ steps.upload.outputs['01_before_hackline_url'] }}) | ![After](${{ steps.upload.outputs['03_after_hackline_jk_url'] }}) |

            #### Nerd Fonts
            | After (HackLineNF) | After (HackLineJKNF) |
            |---|---|
            | ![Nerd Font](${{ steps.upload.outputs['04_after_hackline_nf_url'] }}) | ![Nerd Font JK](${{ steps.upload.outputs['05_after_hackline_jknf_url'] }}) |
